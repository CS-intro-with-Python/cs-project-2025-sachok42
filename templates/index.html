<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Euler Diagram Visualizer</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/benfred/venn.js@master/venn.js"></script>
    <style>
        :root { --primary: #2563eb; --bg: #f8fafc; }
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        .sidebar { width: 350px; background: white; border-right: 1px solid #ddd; padding: 20px; overflow-y: auto; z-index: 10; flex-shrink: 0; }
        .sidebar h3 { margin-top: 0; color: #1e293b; }

        .input-card { background: #f1f5f9; padding: 10px; border-radius: 8px; margin-bottom: 8px; }
        input, textarea { width: 100%; margin-bottom: 5px; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; display: block; font-family: inherit; }
        textarea { height: 40px; resize: vertical; font-size: 12px; }

        button { width: 100%; padding: 12px; margin-top: 10px; cursor: pointer; border-radius: 6px; border: none; font-weight: 600; transition: all 0.2s; }
        button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-update { background: var(--primary); color: white; }
        .btn-save { background: #10b981; color: white; }
        .btn-download { background: #8b5cf6; color: white; }
        .btn-load { background: #f59e0b; color: white; margin-top: 20px; }
        .btn-logout { background: #ef4444; color: white; }

        .canvas-area { flex-grow: 1; position: relative; background: white; overflow: hidden; }
        #venn { width: 100%; height: 100%; min-width: 500px; min-height: 500px; }

        .venntooltip { position: absolute; padding: 8px 12px; background: rgba(0,0,0,0.85); color: white; border-radius: 6px; opacity: 0; pointer-events: none; z-index: 1000; font-size: 13px; }

        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
        .modal-content { background-color: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 80%; max-width: 800px; max-height: 80vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; color: #1e293b; }
        .close { color: #94a3b8; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #64748b; }

        .diagram-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .diagram-card { border: 2px solid #e2e8f0; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.2s; position: relative; }
        .diagram-card:hover { border-color: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15); }
        .diagram-card h4 { margin: 0 0 10px 0; color: #1e293b; font-size: 14px; }
        .diagram-card .date { font-size: 11px; color: #64748b; margin-bottom: 10px; }
        .diagram-card .thumbnail { width: 100%; height: 120px; background: #f1f5f9; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #94a3b8; }
        .diagram-card .delete-btn { position: absolute; top: 10px; right: 10px; background: #ef4444; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px; cursor: pointer; }
        .diagram-card .delete-btn:hover { background: #dc2626; }

        .save-modal-input { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 14px; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="sidebar">
    <h3>Euler Diagram Visualizer</h3>

    <div id="input-container"></div>

    <button class="btn-update" onclick="updateDiagram()">Update Diagram</button>
    <button class="btn-save" onclick="openSaveModal()">Save Diagram</button>
    <button class="btn-download" onclick="downloadSVG()">Download SVG</button>
    <button class="btn-load" onclick="openLoadModal()">Load Saved Diagrams</button>
    <button class="btn-logout" onclick="logout()">Logout</button>
</div>

<div class="canvas-area">
    <div id="venn"></div>
    <div class="venntooltip"></div>
</div>

<!-- Save Modal -->
<div id="saveModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Save Diagram</h2>
            <span class="close" onclick="closeSaveModal()">&times;</span>
        </div>
        <input type="text" id="diagramName" class="save-modal-input" placeholder="Enter diagram name...">
        <button class="btn-save" onclick="saveDiagram()">Save</button>
    </div>
</div>

<!-- Load Modal -->
<div id="loadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Load Diagram</h2>
            <span class="close" onclick="closeLoadModal()">&times;</span>
        </div>
        <div id="diagramGrid" class="diagram-grid"></div>
    </div>
</div>

<script>
    // Initialize input fields
    const container = document.getElementById('input-container');
    for (let i = 1; i <= 10; i++) {
        container.innerHTML += `
            <div class="input-card">
                <input type="text" id="name-${i}" placeholder="Set ${i} name">
                <textarea id="data-${i}" placeholder="Enter elements (comma-separated)"></textarea>
            </div>`;
    }

    const zoom = d3.zoom().on("zoom", () => {
        d3.select("#venn svg g").attr("transform", d3.event.transform);
    });

    function updateDiagram() {
        const setsMap = {};
        const setNames = [];

        for (let i = 1; i <= 10; i++) {
            const name = document.getElementById(`name-${i}`).value.trim();
            const elements = document.getElementById(`data-${i}`).value.split(',').map(s => s.trim()).filter(s => s);
            if (name && elements.length > 0) {
                setsMap[name] = elements.slice(0, 15);
                setNames.push(name);
            }
        }

        const div = d3.select("#venn");
        div.selectAll("*").remove();

        if (setNames.length === 0) {
            div.append("div")
                .style("display", "flex")
                .style("align-items", "center")
                .style("justify-content", "center")
                .style("height", "100%")
                .style("color", "#94a3b8")
                .style("font-size", "16px")
                .text("Enter sets and elements to generate diagram");
            return;
        }

        const vennData = [];
        const combinations = (arr) => arr.reduce((acc, v) => acc.concat(acc.map(r => [v, ...r])), [[]]).filter(r => r.length);
        const combos = combinations(setNames);

        combos.forEach(combo => {
            let intersection = setsMap[combo[0]];
            for(let i=1; i<combo.length; i++) {
                intersection = intersection.filter(x => setsMap[combo[i]].includes(x));
            }

            if (intersection.length > 0) {
                let exclusive = intersection.filter(item => {
                    return setNames.filter(sn => setsMap[sn].includes(item)).length === combo.length;
                });

                vennData.push({ sets: combo, size: intersection.length, items: exclusive.join(", ") });
            }
        });

        const rect = div.node().getBoundingClientRect();
        const width = rect.width || 800;
        const height = rect.height || 600;

        const chart = venn.VennDiagram().width(width).height(height);
        const svg = div.append("svg").attr("width", "100%").attr("height", "100%").call(zoom);
        const g = svg.append("g");

        g.datum(vennData).call(chart);

        // Enhanced labeling
        g.selectAll(".venn-area").each(function(d) {
            const area = d3.select(this);
            const label = area.select("text");

            if (d.items && d.items.length > 0) {
                let x, y;
                if (!label.empty()) {
                    x = label.attr("x");
                    y = parseFloat(label.attr("y")) + 14;
                } else {
                    const bbox = area.select("path").node().getBBox();
                    x = bbox.x + bbox.width / 2;
                    y = bbox.y + bbox.height / 2;
                }

                area.append("text")
                    .attr("x", x)
                    .attr("y", y)
                    .attr("text-anchor", "middle")
                    .attr("class", "item-label")
                    .style("fill", "#444")
                    .style("font-size", "9px")
                    .style("pointer-events", "none")
                    .text(d.items);
            }
        });

        // Tooltip
        const tooltip = d3.select(".venntooltip");
        g.selectAll("g")
            .on("mouseover", function(d) {
                tooltip.transition().duration(200).style("opacity", .9);
                tooltip.html(`<strong>${d.sets.join(" & ")}</strong><br>${d.size} items`);
                d3.select(this).select("path").style("fill-opacity", .4);
            })
            .on("mousemove", function() {
                tooltip.style("left", (d3.event.pageX + 10) + "px").style("top", (d3.event.pageY - 20) + "px");
            })
            .on("mouseout", function() {
                tooltip.transition().duration(200).style("opacity", 0);
                d3.select(this).select("path").style("fill-opacity", .25);
            });
    }

    function downloadSVG() {
        const svg = document.querySelector("#venn svg");
        if (!svg) {
            alert("Please generate a diagram first");
            return;
        }
        const serializer = new XMLSerializer();
        const source = '<?xml version="1.0" standalone="no"?>\r\n' + serializer.serializeToString(svg);
        const url = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(source);
        const link = document.createElement("a");
        link.href = url;
        link.download = "euler_diagram.svg";
        link.click();
    }

    function getCurrentDiagramData() {
        const data = {};
        for (let i = 1; i <= 10; i++) {
            const name = document.getElementById(`name-${i}`).value.trim();
            const elements = document.getElementById(`data-${i}`).value.trim();
            if (name || elements) {
                data[`name-${i}`] = name;
                data[`data-${i}`] = elements;
            }
        }
        return data;
    }

    function loadDiagramData(data) {
        // Clear all fields first
        for (let i = 1; i <= 10; i++) {
            document.getElementById(`name-${i}`).value = '';
            document.getElementById(`data-${i}`).value = '';
        }

        // Load saved data
        for (let key in data) {
            const element = document.getElementById(key);
            if (element) {
                element.value = data[key];
            }
        }

        updateDiagram();
    }

    function openSaveModal() {
        const svg = document.querySelector("#venn svg");
        if (!svg) {
            alert("Please generate a diagram first");
            return;
        }
        document.getElementById('saveModal').style.display = 'block';
    }

    function closeSaveModal() {
        document.getElementById('saveModal').style.display = 'none';
        document.getElementById('diagramName').value = '';
    }

    async function saveDiagram() {
        const name = document.getElementById('diagramName').value.trim();
        if (!name) {
            alert("Please enter a diagram name");
            return;
        }

        const diagramData = getCurrentDiagramData();
        const svg = document.querySelector("#venn svg");
        const thumbnail = svg ? new XMLSerializer().serializeToString(svg) : '';

        try {
            const response = await fetch('/save_diagram', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: name,
                    diagram: diagramData,
                    thumbnail: thumbnail.substring(0, 1000) // Truncate for storage
                })
            });

            if (response.ok) {
                alert("Diagram saved successfully!");
                closeSaveModal();
            } else {
                alert("Failed to save diagram");
            }
        } catch (error) {
            alert("Error saving diagram: " + error.message);
        }
    }

    async function openLoadModal() {
        document.getElementById('loadModal').style.display = 'block';
        await loadThumbnails();
    }

    function closeLoadModal() {
        document.getElementById('loadModal').style.display = 'none';
    }

    async function loadThumbnails() {
        try {
            const response = await fetch('/load_thumbnails');
            const diagrams = await response.json();

            const grid = document.getElementById('diagramGrid');
            grid.innerHTML = '';

            if (diagrams.length === 0) {
                grid.innerHTML = '<p style="color: #94a3b8; text-align: center; padding: 40px;">No saved diagrams yet</p>';
                return;
            }

            diagrams.forEach(diagram => {
                const card = document.createElement('div');
                card.className = 'diagram-card';
                card.innerHTML = `
                    <button class="delete-btn" onclick="deleteDiagram(${diagram.id}, event)">Delete</button>
                    <h4>${diagram.name}</h4>
                    <div class="date">${new Date(diagram.created_at).toLocaleDateString()}</div>
                    <div class="thumbnail">Diagram Preview</div>
                `;
                card.onclick = () => loadDiagramById(diagram.id);
                grid.appendChild(card);
            });
        } catch (error) {
            alert("Error loading diagrams: " + error.message);
        }
    }

    async function loadDiagramById(id) {
        try {
            const response = await fetch(`/load_diagram/${id}`);
            const data = await response.json();
            loadDiagramData(data);
            closeLoadModal();
        } catch (error) {
            alert("Error loading diagram: " + error.message);
        }
    }

    async function deleteDiagram(id, event) {
        event.stopPropagation();
        if (!confirm("Are you sure you want to delete this diagram?")) {
            return;
        }

        try {
            const response = await fetch(`/delete_diagram/${id}`, { method: 'DELETE' });
            if (response.ok) {
                await loadThumbnails();
            } else {
                alert("Failed to delete diagram");
            }
        } catch (error) {
            alert("Error deleting diagram: " + error.message);
        }
    }

    function logout() {
        if (confirm("Are you sure you want to logout?")) {
            window.location.href = '/logout';
        }
    }

    // Close modals when clicking outside
    window.onclick = function(event) {
        const saveModal = document.getElementById('saveModal');
        const loadModal = document.getElementById('loadModal');
        if (event.target == saveModal) {
            closeSaveModal();
        }
        if (event.target == loadModal) {
            closeLoadModal();
        }
    }

    window.onresize = updateDiagram;
</script>
</body>
</html>